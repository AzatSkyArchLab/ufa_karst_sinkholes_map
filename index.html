<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Карстовые провалы Уфы</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
<style>
:root {
    --bg-primary: rgba(255, 255, 255, 0.95);
    --bg-secondary: #f5f5f5;
    --bg-hover: #eee;
    --text-primary: #1a1a1a;
    --text-secondary: #555;
    --text-muted: #888;
    --border-color: #eee;
    --accent: #1d3557;
    --shadow: rgba(0, 0, 0, 0.12);
    --shadow-hover: rgba(0, 0, 0, 0.16);
}

[data-theme="dark"] {
    --bg-primary: rgba(30, 30, 35, 0.95);
    --bg-secondary: #2a2a30;
    --bg-hover: #3a3a42;
    --text-primary: #f0f0f0;
    --text-secondary: #b0b0b0;
    --text-muted: #888;
    --border-color: #404048;
    --accent: #5d8aa8;
    --shadow: rgba(0, 0, 0, 0.4);
    --shadow-hover: rgba(0, 0, 0, 0.5);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body { 
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    transition: background 0.3s ease;
}

#map { 
    position: absolute; 
    top: 0; 
    bottom: 0; 
    width: 100%; 
}

/* Info panel */
.info-panel {
    position: absolute;
    top: 16px;
    left: 16px;
    background: var(--bg-primary);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    padding: 16px 20px;
    max-width: 340px;
    box-shadow: 0 4px 24px var(--shadow);
    z-index: 1000;
    transition: all 0.3s ease;
}

.info-panel:hover {
    box-shadow: 0 6px 32px var(--shadow-hover);
}

.info-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}

.info-panel h2 {
    font-size: 15px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.info-panel h2::before {
    content: '';
    width: 4px;
    height: 16px;
    background: linear-gradient(180deg, #ff8c00, #ff5500);
    border-radius: 2px;
}

.toggle-btn {
    display: none;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    background: var(--bg-secondary);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
}

.toggle-btn:hover {
    background: var(--bg-hover);
}

.toggle-btn svg {
    width: 18px;
    height: 18px;
    color: var(--text-secondary);
    transition: transform 0.3s ease;
}

.info-panel.collapsed .toggle-btn svg {
    transform: rotate(180deg);
}

.info-panel-content {
    transition: all 0.3s ease;
    overflow: hidden;
}

.info-panel p {
    font-size: 12px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-top: 12px;
    margin-bottom: 12px;
}

/* Controls section */
.controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.control-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
}

.control-buttons {
    display: flex;
    gap: 6px;
}

.control-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 8px 10px;
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
    background: var(--bg-secondary);
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.control-btn:hover {
    background: var(--bg-hover);
}

.control-btn.active {
    background: var(--accent);
    color: #fff;
}

.control-btn svg {
    width: 14px;
    height: 14px;
    opacity: 0.7;
}

.control-btn.active svg {
    opacity: 1;
}

/* Toggle switch */
.toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0;
}

.toggle-text {
    font-size: 12px;
    color: var(--text-secondary);
}

.toggle-switch {
    position: relative;
    width: 40px;
    height: 22px;
    background: var(--bg-secondary);
    border-radius: 11px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.toggle-switch.active {
    background: var(--accent);
}

.toggle-switch::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    width: 16px;
    height: 16px;
    background: #fff;
    border-radius: 50%;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.toggle-switch.active::after {
    left: 21px;
}

/* Legend */
.legend {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--text-secondary);
}

.legend-dot-real {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #1d3557;
    border: 3px solid #fff;
    box-shadow: 0 2px 6px rgba(29, 53, 87, 0.4);
}

[data-theme="dark"] .legend-dot-real {
    background: #5d8aa8;
}

.legend-dot-book {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #e63946;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.legend-area {
    width: 16px;
    height: 10px;
    border-radius: 2px;
    background: rgba(255, 140, 0, 0.5);
    border: 1px solid rgba(255, 100, 0, 0.6);
}

.legend-dot-shtolnya {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #7c3aed;
    border: 3px solid #fff;
    box-shadow: 0 2px 6px rgba(124, 58, 237, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
}

.legend-label {
    flex: 1;
}

.legend-label strong {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
}

.legend-label small {
    color: var(--text-muted);
    font-size: 10px;
}

/* Sources */
.sources {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.sources-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.source-link {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--text-secondary);
    text-decoration: none;
    padding: 6px 10px;
    background: var(--bg-secondary);
    border-radius: 6px;
    transition: all 0.2s ease;
    margin-bottom: 6px;
}

.source-link:last-child {
    margin-bottom: 0;
}

.source-link:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.source-link svg {
    width: 12px;
    height: 12px;
    opacity: 0.6;
    flex-shrink: 0;
}

/* Action buttons */
.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    font-size: 12px;
    font-weight: 500;
    text-decoration: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
}

.action-btn svg {
    width: 16px;
    height: 16px;
}

.action-btn.report {
    background: #10b981;
    color: #fff;
}

.action-btn.report:hover {
    background: #059669;
    transform: translateY(-1px);
}

.action-btn.download {
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.action-btn.download:hover {
    background: var(--bg-hover);
}

/* Nav links */
.nav-links {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
}

.nav-link {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-size: 11px;
    font-weight: 500;
    color: var(--text-secondary);
    text-decoration: none;
    padding: 8px 12px;
    background: var(--bg-secondary);
    border-radius: 8px;
    transition: all 0.2s ease;
}

.nav-link:hover {
    background: var(--accent);
    color: #fff;
}

.nav-link:hover svg {
    opacity: 1;
}

.nav-link svg {
    width: 14px;
    height: 14px;
    opacity: 0.6;
    flex-shrink: 0;
}

/* Buy poster button */
.buy-poster-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
    margin-top: 12px;
    padding: 12px 16px;
    font-size: 13px;
    font-weight: 600;
    color: #fff !important;
    text-decoration: none;
    background: linear-gradient(135deg, #ff8c00 0%, #ff6600 100%);
    border-radius: 10px;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(255, 100, 0, 0.3);
}

.buy-poster-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 100, 0, 0.4);
    color: #fff !important;
}

.buy-poster-btn svg {
    width: 18px;
    height: 18px;
    stroke: #fff;
}

/* Popup styles */
.mapboxgl-popup {
    max-width: 300px !important;
}

.mapboxgl-popup-content {
    padding: 16px 18px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
}

[data-theme="dark"] .mapboxgl-popup-content {
    background: #2a2a30 !important;
    color: #f0f0f0;
}

.mapboxgl-popup-close-button {
    font-size: 18px;
    padding: 4px 8px;
    color: #999;
}

[data-theme="dark"] .mapboxgl-popup-close-button {
    color: #888;
}

.mapboxgl-popup-close-button:hover {
    background: transparent;
    color: #333;
}

[data-theme="dark"] .mapboxgl-popup-close-button:hover {
    color: #fff;
}

[data-theme="dark"] .mapboxgl-popup-anchor-bottom .mapboxgl-popup-tip {
    border-top-color: #2a2a30 !important;
}

[data-theme="dark"] .mapboxgl-popup-anchor-top .mapboxgl-popup-tip {
    border-bottom-color: #2a2a30 !important;
}

[data-theme="dark"] .mapboxgl-popup-anchor-left .mapboxgl-popup-tip {
    border-right-color: #2a2a30 !important;
}

[data-theme="dark"] .mapboxgl-popup-anchor-right .mapboxgl-popup-tip {
    border-left-color: #2a2a30 !important;
}

.popup-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

[data-theme="dark"] .popup-title {
    color: #f0f0f0;
}

.popup-subtitle {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border-color);
}

[data-theme="dark"] .popup-subtitle {
    color: #b0b0b0;
    border-bottom-color: #404048;
}

.popup-meta {
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
}

[data-theme="dark"] .popup-meta {
    color: #a0a0a0;
}

.popup-meta strong {
    color: var(--text-primary);
}

[data-theme="dark"] .popup-meta strong {
    color: #e0e0e0;
}

.popup-note {
    font-size: 11px;
    color: var(--text-muted);
    line-height: 1.5;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--border-color);
}

[data-theme="dark"] .popup-note {
    color: #888;
    border-top-color: #404048;
}

.popup-note a {
    color: var(--text-secondary);
    text-decoration: underline;
    text-decoration-style: dotted;
    text-underline-offset: 2px;
}

[data-theme="dark"] .popup-note a {
    color: #a0a0a0;
}

.popup-note a:hover {
    color: var(--text-primary);
}

[data-theme="dark"] .popup-note a:hover {
    color: #fff;
}

.popup-badge {
    display: inline-block;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 3px 6px;
    border-radius: 4px;
    margin-bottom: 8px;
}

.popup-badge.real {
    background: #1d3557;
    color: #fff;
}

[data-theme="dark"] .popup-badge.real {
    background: #5d8aa8;
}

.popup-badge.book {
    background: #e63946;
    color: #fff;
}

.popup-badge.shtolnya {
    background: #7c3aed;
    color: #fff;
}

/* Warning box */
.popup-warning {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 10px 12px;
    border-radius: 0 6px 6px 0;
    margin: 10px 0;
}

.popup-warning-title {
    font-size: 11px;
    font-weight: 600;
    color: #92400e;
    margin-bottom: 4px;
}

.popup-warning-text {
    font-size: 10px;
    color: #78350f;
    line-height: 1.4;
}

[data-theme="dark"] .popup-warning {
    background: #422006;
    border-left-color: #d97706;
}

[data-theme="dark"] .popup-warning-title {
    color: #fbbf24;
}

[data-theme="dark"] .popup-warning-text {
    color: #fcd34d;
}

/* Photo gallery in popup */
.popup-gallery {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    margin-top: 10px;
    padding: 8px 0;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
}

.popup-gallery::-webkit-scrollbar {
    height: 4px;
}

.popup-gallery::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 2px;
}

.popup-gallery::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 2px;
}

.popup-gallery-item {
    flex-shrink: 0;
    width: 120px;
    height: 90px;
    border-radius: 6px;
    overflow: hidden;
    scroll-snap-align: start;
    cursor: pointer;
    position: relative;
    background: #f5f5f5;
}

.popup-gallery-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s ease;
}

.popup-gallery-item:hover img {
    transform: scale(1.05);
}

.popup-gallery-count {
    font-size: 10px;
    color: #888;
    margin-top: 4px;
}

/* Lightbox */
.lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 3000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.lightbox.visible {
    opacity: 1;
    visibility: visible;
}

.lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.lightbox-close svg {
    width: 24px;
    height: 24px;
    color: #fff;
}

.lightbox-img {
    max-width: 90vw;
    max-height: 85vh;
    object-fit: contain;
    border-radius: 4px;
}

.lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 50px;
    height: 50px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
}

.lightbox-nav svg {
    width: 24px;
    height: 24px;
    color: #fff;
}

.lightbox-prev {
    left: 20px;
}

.lightbox-next {
    right: 20px;
}

.lightbox-counter {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    color: #fff;
    font-size: 14px;
    background: rgba(0, 0, 0, 0.5);
    padding: 6px 12px;
    border-radius: 20px;
}

/* Promo popup */
.promo-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
}

.promo-overlay.visible {
    opacity: 1;
    visibility: visible;
}

.promo-popup {
    background: #fff;
    border-radius: 16px;
    padding: 0;
    max-width: 420px;
    width: calc(100% - 32px);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    transform: scale(0.9) translateY(20px);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    overflow: hidden;
    position: relative;
}

.promo-overlay.visible .promo-popup {
    transform: scale(1) translateY(0);
}

.promo-close {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 32px;
    height: 32px;
    border: none;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.promo-close:hover {
    background: #fff;
    transform: scale(1.1);
}

.promo-close svg {
    width: 18px;
    height: 18px;
    color: #555;
}

.promo-image {
    position: relative;
    width: 100%;
    height: 200px;
    background: linear-gradient(135deg, #1d3557 0%, #457b9d 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.promo-image::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.5;
}

.promo-preview {
    width: 160px;
    height: 120px;
    background: #fff;
    border-radius: 4px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3), 0 0 0 8px rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    color: #999;
    position: relative;
    z-index: 1;
    transform: rotate(-3deg);
    overflow: hidden;
}

.promo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.promo-badge {
    position: absolute;
    top: 16px;
    left: 16px;
    background: #ff8c00;
    color: #fff;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 5px 10px;
    border-radius: 20px;
    z-index: 2;
}

.promo-content {
    padding: 24px;
    text-align: center;
}

.promo-title {
    font-size: 20px;
    font-weight: 700;
    color: #1a1a1a;
    margin-bottom: 8px;
    line-height: 1.3;
}

.promo-subtitle {
    font-size: 14px;
    color: #666;
    line-height: 1.5;
    margin-bottom: 20px;
}

.promo-features {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.promo-feature {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: #555;
}

.promo-feature svg {
    width: 16px;
    height: 16px;
    color: #1d3557;
}

.promo-buttons {
    display: flex;
    gap: 12px;
}

.promo-btn {
    flex: 1;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.promo-btn-primary {
    background: linear-gradient(135deg, #1d3557 0%, #2a4a6d 100%);
    color: #fff;
    border: none;
    box-shadow: 0 4px 15px rgba(29, 53, 87, 0.3);
}

.promo-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(29, 53, 87, 0.4);
}

.promo-btn-secondary {
    background: transparent;
    color: #666;
    border: 1px solid #ddd;
}

.promo-btn-secondary:hover {
    background: #f5f5f5;
    color: #333;
}

.promo-btn svg {
    width: 18px;
    height: 18px;
}

/* Report mode indicator */
.report-mode-indicator {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #10b981;
    color: #fff;
    padding: 12px 24px;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
    z-index: 1500;
    display: none;
    align-items: center;
    gap: 10px;
}

.report-mode-indicator.visible {
    display: flex;
}

.report-mode-indicator svg {
    width: 20px;
    height: 20px;
}

.report-mode-cancel {
    background: rgba(255,255,255,0.2);
    border: none;
    color: #fff;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
    margin-left: 8px;
}

.report-mode-cancel:hover {
    background: rgba(255,255,255,0.3);
}

/* Mobile */
@media (max-width: 480px) {
    .info-panel {
        left: 10px;
        right: 10px;
        max-width: none;
        padding: 14px 16px;
    }
    
    .toggle-btn {
        display: flex;
    }
    
    .info-panel.collapsed .info-panel-content {
        max-height: 0;
        opacity: 0;
        margin-top: 0;
        pointer-events: none;
    }
    
    .info-panel-content {
        max-height: 2000px;
        opacity: 1;
        margin-top: 4px;
    }
    
    .nav-links {
        flex-direction: column;
    }
    
    .control-buttons {
        flex-wrap: wrap;
    }
    
    .promo-popup {
        max-width: none;
        margin: 16px;
    }
    
    .promo-image {
        height: 160px;
    }
    
    .promo-preview {
        width: 130px;
        height: 100px;
    }
    
    .promo-content {
        padding: 20px;
    }
    
    .promo-title {
        font-size: 18px;
    }
    
    .promo-buttons {
        flex-direction: column;
    }
    
    .report-mode-indicator {
        font-size: 12px;
        padding: 10px 16px;
    }
}
</style>
</head>
<body>

<div id="map"></div>

<!-- Report mode indicator -->
<div class="report-mode-indicator" id="reportModeIndicator">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
        <circle cx="12" cy="10" r="3"></circle>
    </svg>
    Кликните на карту, чтобы указать место
    <button class="report-mode-cancel" id="reportModeCancel">Отмена</button>
</div>

<!-- Lightbox for photos -->
<div class="lightbox" id="lightbox">
    <button class="lightbox-close" id="lightboxClose">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <button class="lightbox-nav lightbox-prev" id="lightboxPrev">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
    </button>
    <img class="lightbox-img" id="lightboxImg" src="" alt="Фото провала">
    <button class="lightbox-nav lightbox-next" id="lightboxNext">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </button>
    <div class="lightbox-counter" id="lightboxCounter">1 / 1</div>
</div>

<!-- Promo popup -->
<div class="promo-overlay" id="promoOverlay">
    <div class="promo-popup">
        <button class="promo-close" id="promoClose" aria-label="Закрыть">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        
        <div class="promo-image">
            <div class="promo-badge">Новинка</div>
            <div class="promo-preview">
                <span>Превью</span>
            </div>
        </div>
        
        <div class="promo-content">
            <div class="promo-title">Карстовая карта Уфы — теперь в печатном виде!</div>
            <div class="promo-subtitle">Повесьте на стену уникальную карту карстоопасных территорий. Отличный подарок для геологов, архитекторов и всех, кто интересуется городом.</div>
            
            <div class="promo-features">
                <div class="promo-feature">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Высокое качество
                </div>
                <div class="promo-feature">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Формат А2 / А1
                </div>
                <div class="promo-feature">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Доставка по Уфе
                </div>
            </div>
            
            <div class="promo-buttons">
                <a href="https://mapufa.ru/karst-print" class="promo-btn promo-btn-primary">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    Купить принт
                </a>
                <button class="promo-btn promo-btn-secondary" id="promoLater">
                    Позже
                </button>
            </div>
        </div>
    </div>
</div>

<div class="info-panel" id="infoPanel">
    <div class="info-panel-header">
        <h2>Карстовые провалы Уфы</h2>
        <button class="toggle-btn" id="toggleBtn" aria-label="Свернуть панель">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="18 15 12 9 6 15"></polyline>
            </svg>
        </button>
    </div>
    
    <div class="info-panel-content">
        <p>Карта карстоопасных территорий и зафиксированных провалов на территории города Уфы и Республики Башкортостан.</p>
    
    <!-- Controls -->
    <div class="controls">
        <div class="control-group">
            <div class="control-label">Стиль карты</div>
            <div class="control-buttons">
                <button class="control-btn active" data-style="light">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    Светлая
                </button>
                <button class="control-btn" data-style="satellite">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    Спутник
                </button>
                <button class="control-btn" data-style="dark">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    Тёмная
                </button>
            </div>
        </div>
        
        <div class="toggle-row">
            <span class="toggle-text">3D здания</span>
            <div class="toggle-switch" id="toggle3D"></div>
        </div>
    </div>
    
    <div class="legend">
        <div class="legend-item">
            <div class="legend-dot-real"></div>
            <div class="legend-label">
                <strong>Реальные провалы</strong>
                <small>База данных ИГ УФИЦ РАН</small>
            </div>
        </div>
        <div class="legend-item">
            <div class="legend-dot-book"></div>
            <div class="legend-label">
                <strong>Провалы из книги</strong>
                <small>Мартин, Абдрахманов</small>
            </div>
        </div>
        <div class="legend-item">
            <div class="legend-area"></div>
            <div class="legend-label">
                <strong>Карстовые зоны</strong>
                <small>Ориентировочные границы</small>
            </div>
        </div>
        <div class="legend-item">
            <div class="legend-dot-shtolnya">⛏</div>
            <div class="legend-label">
                <strong>Штольня</strong>
                <small>Подземные выработки</small>
            </div>
        </div>
    </div>
    
    <!-- Action buttons -->
    <div class="action-buttons">
        <button class="action-btn report" id="reportBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Сообщить о провале
        </button>
        <a href="https://raw.githubusercontent.com/AzatSkyArchLab/ufa_karst_sinkholes_map/main/data/karst_sinkholes.geojson" 
           download="karst_sinkholes.geojson"
           class="action-btn download">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Скачать данные
        </a>
    </div>
    
    <div class="sources">
        <div class="sources-title">Источники</div>
        <a href="https://www.google.com/maps/d/viewer?mid=1Jj_IS6RCUmcdzKrXWFGI3q1CZJYN8Qs" target="_blank" class="source-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </svg>
            База данных А.И. Смирнова (ИГ УФИЦ РАН)
        </a>
        <a href="http://ig.ufaras.ru/File/PubTxt/ABDR/Karst.pdf" target="_blank" class="source-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            «Карст Башкортостана» (PDF)
        </a>
    </div>
    
    <div class="nav-links">
        <a href="https://mapufa.ru/about-karst-map" class="nav-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
            </svg>
            О карте
        </a>
        <a href="https://github.com/AzatSkyArchLab/ufa_karst_sinkholes_map" target="_blank" class="nav-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
            </svg>
            GitHub
        </a>
    </div>
    
    <a href="https://mapufa.ru/karst-print" class="buy-poster-btn" target="_blank">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        Купить постер карты
    </a>
    </div>
</div>

<script>
mapboxgl.accessToken = 'put here your access token';

// Map styles
const mapStyles = {
    light: 'mapbox://styles/mapbox/light-v11',
    satellite: 'mapbox://styles/mapbox/satellite-v9',
    dark: 'mapbox://styles/mapbox/dark-v11'
};

// Data URLs - ОБНОВЛЕНЫ НА НОВЫЙ РЕПОЗИТОРИЙ
const DATA_URLS = {
    book: 'https://raw.githubusercontent.com/AzatSkyArchLab/ufa_karst_sinkholes_map/main/data/karst_areas.geojson',
    real: 'https://raw.githubusercontent.com/AzatSkyArchLab/ufa_karst_sinkholes_map/main/data/karst_sinkholes.geojson',
    shtolnya: 'https://raw.githubusercontent.com/AzatSkyArchLab/ufa_karst_sinkholes_map/main/data/ufa_shtolnya_dudkinsky.geojson'
};

// GitHub repo for issues
const GITHUB_REPO = 'AzatSkyArchLab/ufa_karst_sinkholes_map';

// Cache data
let cachedBookData = null;
let cachedRealData = null;
let cachedShtolnyaData = null;

// State
let currentStyle = 'light';
let is3DEnabled = false;
let currentPopup = null;
let isReportMode = false;

// Pre-fetch data
async function fetchData() {
    try {
        const [bookRes, realRes, shtolnyaRes] = await Promise.all([
            fetch(DATA_URLS.book),
            fetch(DATA_URLS.real),
            fetch(DATA_URLS.shtolnya).catch(() => null)
        ]);
        cachedBookData = await bookRes.json();
        cachedRealData = await realRes.json();
        if (shtolnyaRes) {
            cachedShtolnyaData = await shtolnyaRes.json();
        }
        console.log('Data loaded successfully');
    } catch (e) {
        console.error('Failed to load data:', e);
    }
}

// Start fetching immediately
fetchData();

// Initialize map
const map = new mapboxgl.Map({
    container: 'map',
    style: mapStyles.light,
    center: [56.010417, 54.755885],
    zoom: 11,
    pitch: 0,
    bearing: 0
});

map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

// Close popup helper
function closePopup() {
    if (currentPopup) {
        currentPopup.remove();
        currentPopup = null;
    }
}

// Add layers function
function addKarstLayers() {
    // Wait for data
    if (!cachedBookData || !cachedRealData) {
        setTimeout(addKarstLayers, 100);
        return;
    }

    // Add sources
    if (!map.getSource('karstBook')) {
        map.addSource('karstBook', {
            type: 'geojson',
            data: cachedBookData
        });
    }
    
    if (!map.getSource('karstReal')) {
        map.addSource('karstReal', {
            type: 'geojson',
            data: cachedRealData
        });
    }

    const isDark = currentStyle === 'dark';
    const isSatellite = currentStyle === 'satellite';

    // 1. Karst areas (polygons)
    if (!map.getLayer('karstMeshArea')) {
        map.addLayer({
            'id': 'karstMeshArea',
            'type': 'fill',
            'source': 'karstBook',
            'paint': {
                'fill-color': '#ff8c00',
                'fill-opacity': isSatellite ? 0.5 : 0.3
            },
            'filter': ['==', '$type', 'Polygon']
        });
    }

    // 2. Karst areas outline
    if (!map.getLayer('karstMeshAreaOutline')) {
        map.addLayer({
            'id': 'karstMeshAreaOutline',
            'type': 'line',
            'source': 'karstBook',
            'paint': {
                'line-color': isSatellite ? '#ffaa00' : '#ff6600',
                'line-width': isSatellite ? 2 : 1.5,
                'line-opacity': isSatellite ? 0.9 : 0.6
            },
            'filter': ['==', '$type', 'Polygon']
        });
    }

    // 3. Book points
    if (!map.getLayer('karstPointBook')) {
        map.addLayer({
            'id': 'karstPointBook',
            'type': 'circle',
            'source': 'karstBook',
            'paint': {
                'circle-radius': [
                    'interpolate', ['linear'], ['zoom'],
                    8, 3,
                    12, 5,
                    16, 8
                ],
                'circle-color': '#e63946',
                'circle-stroke-color': '#ffffff',
                'circle-stroke-width': isSatellite ? 2 : 1.5,
                'circle-opacity': 0.9
            },
            'filter': ['==', '$type', 'Point']
        });
    }

    // 4. Real points - TOP
    if (!map.getLayer('karstPointReal')) {
        map.addLayer({
            'id': 'karstPointReal',
            'type': 'circle',
            'source': 'karstReal',
            'paint': {
                'circle-radius': [
                    'interpolate', ['linear'], ['zoom'],
                    8, 5,
                    12, 8,
                    16, 12
                ],
                'circle-color': isDark ? '#5d8aa8' : '#1d3557',
                'circle-stroke-color': '#ffffff',
                'circle-stroke-width': isSatellite ? 3 : 2.5,
                'circle-opacity': 1
            },
            'filter': ['==', '$type', 'Point']
        });
    }
    
    // Add Shtolnya layers
    addShtolnyaLayers();
    
    // Setup interactions after layers are added
    setupInteractions();
}

// Add Shtolnya (mine) layers
function addShtolnyaLayers() {
    // Shtolnya entrance point
    const shtolnyaPoint = {
        type: 'FeatureCollection',
        features: [{
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [56.026102, 54.719579]
            },
            properties: {
                name: 'Дудкинская штольня',
                type: 'mine_entrance'
            }
        }]
    };

    if (!map.getSource('shtolnyaPoint')) {
        map.addSource('shtolnyaPoint', {
            type: 'geojson',
            data: shtolnyaPoint
        });
    }

    // Shtolnya circle marker
    if (!map.getLayer('shtolnyaCircle')) {
        map.addLayer({
            id: 'shtolnyaCircle',
            type: 'circle',
            source: 'shtolnyaPoint',
            paint: {
                'circle-radius': [
                    'interpolate', ['linear'], ['zoom'],
                    8, 8,
                    12, 14,
                    16, 20
                ],
                'circle-color': '#7c3aed',
                'circle-stroke-width': 3,
                'circle-stroke-color': '#ffffff',
                'circle-opacity': 1
            }
        });
    }

    // Shtolnya label
    if (!map.getLayer('shtolnyaLabel')) {
        map.addLayer({
            id: 'shtolnyaLabel',
            type: 'symbol',
            source: 'shtolnyaPoint',
            layout: {
                'text-field': '⛏',
                'text-size': [
                    'interpolate', ['linear'], ['zoom'],
                    8, 12,
                    12, 18,
                    16, 24
                ],
                'text-allow-overlap': true
            },
            paint: {
                'text-color': '#ffffff'
            }
        });
    }

    // Add shtolnya contour if data loaded
    if (cachedShtolnyaData && !map.getSource('shtolnyaArea')) {
        map.addSource('shtolnyaArea', {
            type: 'geojson',
            data: cachedShtolnyaData
        });
        
        map.addLayer({
            id: 'shtolnyaLines',
            type: 'line',
            source: 'shtolnyaArea',
            paint: {
                'line-color': '#7c3aed',
                'line-width': 2,
                'line-opacity': 0.8,
                'line-dasharray': [2, 2]
            }
        });
    }
}

// Add 3D buildings
function add3DBuildings() {
    if (map.getLayer('3d-buildings')) return;
    if (currentStyle === 'satellite') return;
    
    const layers = map.getStyle().layers;
    let labelLayerId;
    for (let i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol' && layers[i].layout && layers[i].layout['text-field']) {
            labelLayerId = layers[i].id;
            break;
        }
    }

    map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 14,
        'paint': {
            'fill-extrusion-color': currentStyle === 'dark' ? '#3a3a42' : '#ddd',
            'fill-extrusion-height': ['get', 'height'],
            'fill-extrusion-base': ['get', 'min_height'],
            'fill-extrusion-opacity': 0.7
        }
    }, labelLayerId);
}

// Remove 3D buildings
function remove3DBuildings() {
    if (map.getLayer('3d-buildings')) {
        map.removeLayer('3d-buildings');
    }
}

// Setup popups and interactions
function setupInteractions() {
    map.off('click', 'karstPointReal', handleRealPointClick);
    map.off('click', 'karstPointBook', handleBookPointClick);
    map.off('click', 'karstMeshArea', handleAreaClick);
    map.off('click', 'shtolnyaCircle', handleShtolnyaClick);
    
    map.on('click', 'karstPointReal', handleRealPointClick);
    map.on('click', 'karstPointBook', handleBookPointClick);
    map.on('click', 'karstMeshArea', handleAreaClick);
    map.on('click', 'shtolnyaCircle', handleShtolnyaClick);

    const interactiveLayers = ['karstMeshArea', 'karstPointBook', 'karstPointReal', 'shtolnyaCircle'];
    
    interactiveLayers.forEach(layer => {
        if (!map.getLayer(layer)) return;
        
        map.on('mouseenter', layer, () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', layer, () => {
            map.getCanvas().style.cursor = isReportMode ? 'crosshair' : '';
        });
    });
}

// Shtolnya click handler
function handleShtolnyaClick(e) {
    e.originalEvent.stopPropagation();
    closePopup();

    const content = `
        <div class="popup-badge shtolnya">⛏️ Штольня</div>
        <div class="popup-title">Дудкинская штольня</div>
        <div class="popup-subtitle">Подземные лабиринты длиной ~2,5 км</div>
        
        <div class="popup-meta">
            <strong>История:</strong> Добыча «Марьиного стекла» с 1920-х до 1950-х годов
        </div>
        <div class="popup-meta">
            <strong>Где:</strong> За ВДНХ, спуск к реке Уфе
        </div>
        
        <div class="popup-warning">
            <div class="popup-warning-title">⚠️ ВНИМАНИЕ — ОПАСНО!</div>
            <div class="popup-warning-text">
                Карта условная! Всё в аварийном состоянии. Возможны обвалы, крепи сгнили. 
                Связь не ловит. Автор не несёт ответственности за использование этой информации. 
                Обязательно предупредите близких перед посещением!
            </div>
        </div>
        
        <div class="popup-meta">
            <strong>Совет:</strong> Возьмите каску, фонарь и запасные батарейки
        </div>
        
        <div class="popup-note">
            Длина системы: 2642 м. Имеются три подземных «озера».<br>
            <a href="https://www.google.com/maps?q=54.719579,56.026102" target="_blank">Открыть в Google Maps →</a>
        </div>
    `;

    currentPopup = new mapboxgl.Popup({ closeOnClick: true, maxWidth: '360px' })
        .setLngLat([56.026102, 54.719579])
        .setHTML(content)
        .addTo(map);
}

// Click handlers
function handleRealPointClick(e) {
    if (isReportMode) return;
    e.originalEvent.stopPropagation();
    closePopup();
    
    const props = e.features[0].properties;
    const name = props.name || 'Карстовый провал';
    const date = props.date || '';
    const type = props.type || '';
    const description = props.description || '';
    const location = props.location || '';
    
    // Parse images array (it comes as string from GeoJSON)
    let images = [];
    if (props.images) {
        try {
            images = typeof props.images === 'string' ? JSON.parse(props.images) : props.images;
        } catch (e) {
            images = [];
        }
    }

    let content = `
        <div class="popup-badge real">Реальные данные</div>
        <div class="popup-title">${name}</div>
    `;

    if (type) {
        content += `<div class="popup-subtitle">${type}</div>`;
    }

    if (date) {
        content += `<div class="popup-meta"><strong>Дата:</strong> ${date}</div>`;
    }
    
    if (location) {
        content += `<div class="popup-meta">${location.substring(0, 150)}${location.length > 150 ? '...' : ''}</div>`;
    }

    if (description && !type && !location) {
        content += `<div class="popup-meta">${description.substring(0, 200)}${description.length > 200 ? '...' : ''}</div>`;
    }
    
    // Add photo gallery if images exist
    if (images && images.length > 0) {
        content += `<div class="popup-gallery">`;
        images.forEach((img, idx) => {
            content += `<div class="popup-gallery-item" onclick="openLightbox(${idx}, '${images.join("','")}')">
                <img src="${img}=w240" alt="Фото ${idx + 1}" loading="lazy">
            </div>`;
        });
        content += `</div>`;
        content += `<div class="popup-gallery-count">${images.length} фото • нажмите для увеличения</div>`;
    }

    content += `
        <div class="popup-note">
            Источник: База данных А.И. Смирнова (ИГ УФИЦ РАН)<br>
            <a href="https://www.google.com/maps/d/viewer?mid=1Jj_IS6RCUmcdzKrXWFGI3q1CZJYN8Qs" target="_blank">Открыть карту →</a>
        </div>
    `;

    currentPopup = new mapboxgl.Popup({ closeOnClick: true, maxWidth: '340px' })
        .setLngLat(e.lngLat)
        .setHTML(content)
        .addTo(map);
}

// Lightbox functionality
let currentImages = [];
let currentImageIndex = 0;

function openLightbox(index, ...images) {
    if (Array.isArray(images[0])) {
        currentImages = images[0];
    } else if (typeof images[0] === 'string' && images[0].includes(',')) {
        currentImages = images[0].split("','");
    } else {
        currentImages = images;
    }
    
    currentImageIndex = index;
    updateLightbox();
    document.getElementById('lightbox').classList.add('visible');
}

function updateLightbox() {
    const img = document.getElementById('lightboxImg');
    const counter = document.getElementById('lightboxCounter');
    
    img.src = currentImages[currentImageIndex] + '=w1200';
    counter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
    
    document.getElementById('lightboxPrev').style.display = currentImages.length > 1 ? 'flex' : 'none';
    document.getElementById('lightboxNext').style.display = currentImages.length > 1 ? 'flex' : 'none';
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('visible');
}

function prevImage() {
    currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
    updateLightbox();
}

function nextImage() {
    currentImageIndex = (currentImageIndex + 1) % currentImages.length;
    updateLightbox();
}

// Lightbox event listeners
document.getElementById('lightboxClose').addEventListener('click', closeLightbox);
document.getElementById('lightboxPrev').addEventListener('click', prevImage);
document.getElementById('lightboxNext').addEventListener('click', nextImage);
document.getElementById('lightbox').addEventListener('click', (e) => {
    if (e.target.id === 'lightbox') closeLightbox();
});
document.addEventListener('keydown', (e) => {
    if (!document.getElementById('lightbox').classList.contains('visible')) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft') prevImage();
    if (e.key === 'ArrowRight') nextImage();
});

function handleBookPointClick(e) {
    if (isReportMode) return;
    e.originalEvent.stopPropagation();
    
    const realPoints = map.queryRenderedFeatures(e.point, { layers: ['karstPointReal'] });
    if (realPoints.length > 0) return;
    
    closePopup();

    const bookPointPopupContent = `
        <div class="popup-badge book">Книга</div>
        <div class="popup-title">Карстовые провалы</div>
        <div class="popup-note">
            Оцифрованная карта из книги Мартина и Абдрахманова «Карст Башкортостана».<br>
            <a href="http://ig.ufaras.ru/File/PubTxt/ABDR/Karst.pdf" target="_blank">См. источник →</a>
        </div>
    `;
    
    currentPopup = new mapboxgl.Popup({ closeOnClick: true })
        .setLngLat(e.lngLat)
        .setHTML(bookPointPopupContent)
        .addTo(map);
}

function handleAreaClick(e) {
    if (isReportMode) return;
    
    const realPoints = map.queryRenderedFeatures(e.point, { layers: ['karstPointReal'] });
    const bookPoints = map.queryRenderedFeatures(e.point, { layers: ['karstPointBook'] });
    if (realPoints.length > 0 || bookPoints.length > 0) return;
    
    closePopup();

    const areaPopupContent = `
        <div class="popup-badge book">Книга</div>
        <div class="popup-title">Области вокруг карстовых провалов</div>
        <div class="popup-note">
            Оцифрованная карта из книги Мартина и Абдрахманова «Карст Башкортостана».<br><br>
            <em>Примечание: ориентировочная карта с погрешностями.</em><br>
            <a href="http://ig.ufaras.ru/File/PubTxt/ABDR/Karst.pdf" target="_blank">См. источник →</a>
        </div>
    `;
    
    currentPopup = new mapboxgl.Popup({ closeOnClick: true })
        .setLngLat(e.lngLat)
        .setHTML(areaPopupContent)
        .addTo(map);
}

// ========================================
// REPORT MODE - Краудсорсинг
// ========================================

function enableReportMode() {
    isReportMode = true;
    map.getCanvas().style.cursor = 'crosshair';
    document.getElementById('reportModeIndicator').classList.add('visible');
    closePopup();
}

function disableReportMode() {
    isReportMode = false;
    map.getCanvas().style.cursor = '';
    document.getElementById('reportModeIndicator').classList.remove('visible');
}

function openGitHubIssue(lat, lng) {
    const title = encodeURIComponent('[Провал] Новый провал');
    const coords = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    const mapsLink = `https://www.google.com/maps?q=${lat},${lng}`;
    
    const body = encodeURIComponent(
`## 📍 Местоположение
**Координаты:** ${coords}
**Карта:** [Открыть в Google Maps](${mapsLink})

**Адрес / описание места:**
<!-- Укажите адрес или опишите местоположение -->


## 📅 Дата образования
<!-- Когда образовался провал (примерно) -->


## 📝 Описание
<!-- Размер, глубина, что произошло, последствия -->


## 📷 Фотографии
<!-- Перетащите фото сюда или вставьте ссылки -->


## 📰 Источник информации
<!-- Личное наблюдение / Новости / СМИ -->


---
✅ Подтверждаю достоверность информации
✅ Согласен на публикацию под лицензией CC BY 4.0`
    );
    
    const url = `https://github.com/${GITHUB_REPO}/issues/new?title=${title}&body=${body}&labels=new-sinkhole,needs-verification`;
    window.open(url, '_blank');
}

// Report mode click handler
map.on('click', (e) => {
    if (isReportMode) {
        const { lat, lng } = e.lngLat;
        openGitHubIssue(lat, lng);
        disableReportMode();
        return;
    }
    
    // Normal click - close popup if empty area
    const features = map.queryRenderedFeatures(e.point, { 
        layers: ['karstPointReal', 'karstPointBook', 'karstMeshArea', 'shtolnyaCircle'] 
    });
    if (features.length === 0) {
        closePopup();
    }
});

// Change map style
function changeStyle(style) {
    closePopup();
    currentStyle = style;
    
    if (style === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
    } else {
        document.body.removeAttribute('data-theme');
    }
    
    document.querySelectorAll('.control-btn[data-style]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.style === style);
    });
    
    map.setStyle(mapStyles[style]);
}

// On style load - re-add layers
map.on('style.load', () => {
    addKarstLayers();
    
    if (is3DEnabled && currentStyle !== 'satellite') {
        setTimeout(() => {
            add3DBuildings();
        }, 100);
    }
});

// Initial load
map.on('load', () => {
    addKarstLayers();
});

// UI Controls
document.addEventListener('DOMContentLoaded', () => {
    // Toggle panel
    const toggleBtn = document.getElementById('toggleBtn');
    const infoPanel = document.getElementById('infoPanel');
    
    toggleBtn.addEventListener('click', () => {
        infoPanel.classList.toggle('collapsed');
    });
    
    // Style buttons
    document.querySelectorAll('.control-btn[data-style]').forEach(btn => {
        btn.addEventListener('click', () => {
            changeStyle(btn.dataset.style);
        });
    });
    
    // 3D toggle
    const toggle3D = document.getElementById('toggle3D');
    toggle3D.addEventListener('click', () => {
        is3DEnabled = !is3DEnabled;
        toggle3D.classList.toggle('active', is3DEnabled);
        
        if (is3DEnabled) {
            if (currentStyle !== 'satellite') {
                add3DBuildings();
            }
            map.easeTo({ pitch: 45, duration: 500 });
        } else {
            remove3DBuildings();
            map.easeTo({ pitch: 0, duration: 500 });
        }
    });
    
    // Report button
    document.getElementById('reportBtn').addEventListener('click', () => {
        enableReportMode();
    });
    
    // Cancel report mode
    document.getElementById('reportModeCancel').addEventListener('click', () => {
        disableReportMode();
    });
    
    // Escape to cancel report mode
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isReportMode) {
            disableReportMode();
        }
    });
    
    // === Promo popup ===
    const promoOverlay = document.getElementById('promoOverlay');
    const promoClose = document.getElementById('promoClose');
    const promoLater = document.getElementById('promoLater');
    
    const lastPromoShown = localStorage.getItem('karstPromoLastShown');
    const now = Date.now();
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    
    const shouldShowPromo = !lastPromoShown || (now - parseInt(lastPromoShown)) > sevenDays;
    
    if (shouldShowPromo) {
        setTimeout(() => {
            promoOverlay.classList.add('visible');
        }, 4000);
    }
    
    function closePromo() {
        promoOverlay.classList.remove('visible');
        localStorage.setItem('karstPromoLastShown', Date.now().toString());
    }
    
    promoClose.addEventListener('click', closePromo);
    promoLater.addEventListener('click', closePromo);
    
    promoOverlay.addEventListener('click', (e) => {
        if (e.target === promoOverlay) {
            closePromo();
        }
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && promoOverlay.classList.contains('visible')) {
            closePromo();
        }
    });
});
</script>

</body>
</html>
